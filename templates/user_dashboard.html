<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>User Dashboard - ERD Generator</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/user_dashboard.css') }}">
    <link href='https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css' rel='stylesheet'>
</head>
<body>
    
    <div class="dashboard-container">
        <!-- Top Navbar -->
        <nav class="top-navbar">
            <div class="navbar-content">
                <!-- Logo -->
                <div class="navbar-logo">
                    <div class="logo-icon">
                        <i class='bx bx-data'></i>
                    </div>
                    <span class="logo-text">ERD Generator</span>
                </div>

                <!-- Navigation Links -->
                <div class="nav-links">
                    <a href="#home" class="nav-link active" data-tab="home" onclick="switchTab('home')">Home</a>
                    <a href="#requests" class="nav-link" data-tab="requests" onclick="switchTab('requests')">Request</a>
                </div>

                <!-- User Account -->
                <div class="user-account">
                    <button class="account-btn" onclick="toggleUserMenu()">
                        <i class='bx bx-user-circle'></i>
                    </button>
                    
                    <!-- User Dropdown Menu -->
                    <div class="user-menu" id="userMenu">
                        <div class="user-menu-header">
                            <div class="user-avatar">
                                <i class='bx bx-user'></i>
                            </div>
                            <div class="user-info">
                                <div class="user-name" id="userName">User Name</div>
                                <div class="user-status">User</div>
                            </div>
                            <div class="user-status-indicator"></div>
                        </div>
                        
                        <div class="user-menu-divider"></div>
                        
                        <button class="user-menu-item logout-item" onclick="logout()">
                            <i class='bx bx-log-out'></i>
                            <span>Logout</span>
                        </button>
                    </div>
                </div>
            </div>
        </nav>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Home Tab -->
            <div id="home-tab" class="tab-content active">
                <!-- Hero Section -->
                <div class="hero-section">
                    <h1 class="hero-title" id="userWelcome">Find an ERD</h1>
                    <p class="hero-subtitle">Temukan dan eksplorasi diagram ERD yang sesuai dengan kebutuhan proyek Anda.</p>
                    
                    <!-- Search Bar -->
                    <div class="hero-search">
                        <i class='bx bx-search'></i>
                        <input type="text" id="userInput" placeholder="Cari berdasarkan nama ERD atau entitas...." />
                    </div>
                </div>

                <!-- Search Options (Hidden by default) -->
                <div class="search-options-section" style="display: none;">
                    <label>
                        Top K:
                        <input type="number" id="topK" min="1" max="20" value="10">
                    </label>
                    <label>
                        Min Similarity:
                        <input type="number" id="minSimilarity" min="0" max="1" step="0.01" value="0.05">
                    </label>
                </div>

                <!-- Results Section -->
                <div class="results-section" id="resultsSection">
                    <!-- Empty State Container -->
                    <div id="emptyStateContainer" class="empty-state-container" style="display: none;">
                        <div id="searchStatus"></div>
                        <button id="askAdvisorBtn" class="ask-advisor-btn" style="display: none;">
                            ðŸ’¡ Minta Bantuan Advisor
                        </button>
                    </div>
                    
                    <!-- Search Results -->
                    <div class="search-results" id="searchResults" style="display: none;">
                        <div class="results-header">
                            <h3 id="searchResultsTitle"></h3>
                        </div>
                        <div class="search-results-grid" id="searchResultsGrid"></div>
                    </div>
                </div>
            </div>

            <!-- Requests Tab -->
            <div id="requests-tab" class="tab-content">
                <div class="requests-header">
                    <h2 class="requests-title">Request ERD Saya</h2>
                    
                    <div class="requests-controls">
                        <div class="filter-group">
                            <button class="filter-btn active" data-filter="all" onclick="filterRequests('all')">
                                Status: All
                                <i class='bx bx-chevron-down'></i>
                            </button>
                        </div>
                        
                        <button id="requestBtn" class="btn-request-new">
                            <i class='bx bx-plus'></i>
                            Request ERD Baru
                        </button>
                    </div>
                </div>

                <div class="requests-section">
                    <div id="requestsLoading" class="loading">Memuat request...</div>
                    <div id="requestsList" class="requests-list"></div>
                </div>
            </div>
        </main>
    </div>

    <!-- Modals tetap sama seperti sebelumnya -->
    <div id="erdModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title" id="modalTitle">Preview ERD</div>
                <button class="close" id="closeModal">&times;</button>
            </div>
            <div class="modal-body">
                <div id="modalLoading" style="display: none;">
                    <div class="loading-spinner"></div>
                    Memuat ERD...
                </div>
                <img id="modalImage" class="modal-image" style="display: none;" />
                <div id="modalError" style="display: none; color: red;"></div>
                <div class="modal-actions" id="modalActions" style="display: none;">
                    <button class="btn-primary" id="fullscreenBtn">Buka Fullscreen</button>
                    <a class="btn-secondary" id="downloadBtn" href="#" download>Unduh ERD</a>
                </div>
            </div>
        </div>
    </div>

    <div id="askAdvisorModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">Minta Bantuan Advisor</div>
                <button class="close" id="closeAskAdvisorModal">&times;</button>
            </div>
            <div class="modal-body">
                <form id="askAdvisorForm">
                    <div class="form-group">
                        <label for="requestQuery">Query/Topik ERD:</label>
                        <input type="text" id="requestQuery">
                    </div>
                    <div class="form-group">
                        <label for="requestDescription">Deskripsi Detail:</label>
                        <textarea 
                            id="requestDescription" 
                            rows="4" 
                            placeholder="Jelaskan secara detail ERD yang Anda butuhkan..."
                            required
                        ></textarea>
                    </div>
                    <div class="modal-actions">
                        <button type="button" onclick="closeAskAdvisorModal()" class="btn-secondary">Batal</button>
                        <button type="submit" class="btn-primary">Kirim Request</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Popups tetap sama -->
    <div class="popup-overlay hidden" id="successPopup">
        <div class="popup">
            <div class="popup-header success">
                <div class="icon-wrapper">
                    <svg class="popup-icon" viewBox="0 0 24 24">
                        <path d="M20 6L9 17l-5-5"></path>
                    </svg>
                </div>
            </div>
            <div class="popup-body">
                <h2 class="popup-title" id="successPopupTitle">Berhasil!</h2>
                <p class="popup-message" id="successPopupMessage">Operasi berhasil dilakukan.</p>
                <div class="popup-buttons single">
                    <button class="popup-btn popup-btn-success" onclick="closeSuccessPopup()">OK</button>
                </div>
            </div>
        </div>
    </div>

    <div class="popup-overlay hidden" id="warningPopup">
        <div class="popup">
            <div class="popup-header warning">
                <div class="icon-wrapper">
                    <svg class="popup-icon" viewBox="0 0 24 24">
                        <circle cx="12" cy="12" r="10"></circle>
                        <path d="M12 16v-4M12 8h.01"></path>
                    </svg>
                </div>
            </div>
            <div class="popup-body">
                <h2 class="popup-title" id="warningPopupTitle">Konfirmasi</h2>
                <p class="popup-message" id="warningPopupMessage">Apakah Anda yakin?</p>
                <div class="popup-buttons">
                    <button class="popup-btn popup-btn-secondary" onclick="closeWarningPopup(false)">Batal</button>
                    <button class="popup-btn popup-btn-warning" onclick="closeWarningPopup(true)">Ya, Lanjutkan</button>
                </div>
            </div>
        </div>
    </div>

    <div class="popup-overlay hidden" id="errorPopup">
        <div class="popup">
            <div class="popup-header error">
                <div class="icon-wrapper">
                    <svg class="popup-icon" viewBox="0 0 24 24">
                        <circle cx="12" cy="12" r="10"></circle>
                        <line x1="15" y1="9" x2="9" y2="15"></line>
                        <line x1="9" y1="9" x2="15" y2="15"></line>
                    </svg>
                </div>
            </div>
            <div class="popup-body">
                <h2 class="popup-title" id="errorPopupTitle">Gagal!</h2>
                <p class="popup-message" id="errorPopupMessage">Terjadi kesalahan.</p>
                <div class="popup-buttons single">
                    <button class="popup-btn popup-btn-error" onclick="closeErrorPopup()">OK</button>
                </div>
            </div>
        </div>
    </div>

    <script src="{{ url_for('static', filename='js/auth.js') }}"></script>
    <script src="{{ url_for('static', filename='js/main.js') }}"></script>
    <script src="{{ url_for('static', filename='js/user_dashboard.js') }}"></script>
    
    <script>
        // Toggle User Menu
        function toggleUserMenu() {
            const menu = document.getElementById('userMenu');
            menu.classList.toggle('active');
        }

        // Close menu when clicking outside
        document.addEventListener('click', function(event) {
            const userAccount = document.querySelector('.user-account');
            const userMenu = document.getElementById('userMenu');
            
            if (!userAccount.contains(event.target)) {
                userMenu.classList.remove('active');
            }
        });

        // Switch Tab Function
        function switchTab(tabName) {
            // Update nav links
            document.querySelectorAll('.nav-link').forEach(link => {
                link.classList.remove('active');
            });
            document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');
            
            // Update tab content
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            document.getElementById(`${tabName}-tab`).classList.add('active');
            
            // Load data based on tab
            if (tabName === 'home') {
                // Home tab logic
            } else if (tabName === 'requests') {
                loadUserRequests();
            }
        }

        // Initialize on load
        document.addEventListener('DOMContentLoaded', function() {
            if (!requireAuth()) return;
            
            const user = getUser();
            if (!user || user.role !== 'user') {
                window.location.href = '/login';
                return;
            }

            // Set user name
            document.getElementById('userName').textContent = user.username || user.email;
            
            initUserDashboard();
            
            // Handle search on Enter
            document.getElementById('userInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    const query = this.value.trim();
                    if (query) {
                        const topK = parseInt(document.getElementById('topK').value) || 10;
                        const minSimilarity = parseFloat(document.getElementById('minSimilarity').value) || 0.05;
                        searchERD(query, topK, minSimilarity);
                    }
                }
            });
        });
    </script>
</body>
</html>