<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>User Dashboard - ERD Generator</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/user_dashboard.css') }}">
    <link href='https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css' rel='stylesheet'>
</head>
<body>
    
    <!-- Navigation -->
    <nav class="navbar">    
        <div class="nav-container">
            <div class="nav-brand">
                <h2>üéØ ERD Generator</h2>
            </div>
            <div class="nav-menu">
                <span id="userWelcome">Loading...</span>
                <button onclick="logout()" class="logout-btn">Logout</button>
            </div>
        </div>
    </nav>

    <div class="dashboard-container">
        <!-- Sidebar -->
        <aside class="sidebar" id="sidebar">
            <!-- Toggle Button -->
            <button class="sidebar-toggle" id="sidebarToggle" onclick="toggleSidebar()">
                <i class='bx bx-chevron-left'></i>
            </button>

            <div class="sidebar-menu">
                <a href="#search" class="menu-item active" data-tab="search" onclick="switchTab('search')">
                    <span>üîç</span>
                    <span>Cari ERD</span>
                </a>
                <a href="#requests" class="menu-item" data-tab="requests" onclick="switchTab('requests')">
                    <span>üìã</span>
                    <span>Request Saya</span>
                </a>
                <a href="#history" class="menu-item" data-tab="history" onclick="switchTab('history')">
                    <span>üìö</span>
                    <span>Riwayat</span>
                </a>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Search Tab -->
            <div id="search-tab" class="tab-content active">
                <div class="content-header">
                    <h2>Pencarian ERD</h2>
                    <p>Cari ERD yang sesuai dengan kebutuhan Anda</p>
                </div>

                <div class="search-section">
                    <form id="erdForm">
                        <div class="input-group">
                            <input
                                type="text"
                                id="userInput"
                                placeholder="Contoh: perpustakaan, sistem akademik, penjualan, dll..."
                                required
                            />
                            <button type="submit" id="searchBtn">
                                <span id="searchBtnText">Cari ERD</span>
                                <span id="searchSpinner" class="loading-spinner" style="display: none;"></span>
                            </button>
                        </div>
                        
                        <div class="search-options">
                            <label>
                                Top K:
                                <input type="number" id="topK" min="1" max="20" value="10">
                            </label>
                            <label>
                                Min Similarity:
                                <input type="number" id="minSimilarity" min="0" max="1" step="0.01" value="0.05">
                            </label>
                        </div>
                    </form>
                </div>

                <div class="results-section" id="resultsSection">
                    <!-- CONTAINER UNTUK EMPTY STATE (CENTERED) -->
                    <div id="emptyStateContainer" class="empty-state-container" style="display: none;">
                        <div id="searchStatus"></div>
                        <button id="askAdvisorBtn" class="ask-advisor-btn" style="display: none;">
                            üí° Minta Bantuan Advisor
                        </button>
                    </div>
                        
                        <!-- CONTAINER UNTUK HASIL PENCARIAN (NORMAL) -->
                    <div class="search-results" id="searchResults" style="display: none;">
                        <div class="results-header">
                            <h3 id="searchResultsTitle"></h3>
                        </div>
                        <div class="search-results-grid" id="searchResultsGrid"></div>
                    </div>
                </div>
            </div>

            <!-- Requests Tab -->
            <div id="requests-tab" class="tab-content">
                <!-- Header with Title, Filters, and Button -->
                <div class="requests-header">
                    <h2 class="requests-title">Request ERD Saya</h2>
                    
                    <div class="requests-controls">
                        <!-- Filter Buttons -->
                        <div class="filter-group">
                            <button class="filter-btn active" data-filter="all" onclick="filterRequests('all')">
                                Status: All
                                <i class='bx bx-chevron-down'></i>
                            </button>
                            <!-- Uncomment for more filters
                            <button class="filter-btn" data-filter="pending" onclick="filterRequests('pending')">
                                Pending
                            </button>
                            <button class="filter-btn" data-filter="in_progress" onclick="filterRequests('in_progress')">
                                In Progress
                            </button>
                            <button class="filter-btn" data-filter="complete" onclick="filterRequests('complete')">
                                Completed
                            </button>
                            -->
                        </div>
                        
                        <!-- Request ERD Baru Button -->
                        <button class="btn-request-new" onclick="openRequestModal()">
                            <i class='bx bx-plus'></i>
                            Request ERD Baru
                        </button>
                    </div>
                </div>

                <!-- Requests List -->
                <div class="requests-section">
                    <div id="requestsLoading" class="loading">Memuat request...</div>
                    <div id="requestsList" class="requests-list"></div>
                </div>
            </div>

            <!-- History Tab -->
            <div id="history-tab" class="tab-content">
                <div class="content-header">
                    <h2>Riwayat ERD</h2>
                    <p>ERD yang telah Anda akses dan request yang telah selesai</p>
                </div>

                <div class="history-section">
                    <div id="historyLoading" class="loading">Memuat riwayat...</div>
                    <div id="historyList" class="history-list"></div>
                </div>
            </div>
        </main>
    </div>

    <!-- Modal for ERD Preview -->
    <div id="erdModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title" id="modalTitle">Preview ERD</div>
                <button class="close" id="closeModal">&times;</button>
            </div>
            <div class="modal-body">
                <div id="modalLoading" style="display: none;">
                    <div class="loading-spinner"></div>
                    Memuat ERD...
                </div>
                <img id="modalImage" class="modal-image" style="display: none;" />
                <div id="modalError" style="display: none; color: red;"></div>
                <div class="modal-actions" id="modalActions" style="display: none;">
                    <button class="btn-primary" id="fullscreenBtn">Buka Fullscreen</button>
                    <a class="btn-secondary" id="downloadBtn" href="#" download>Unduh ERD</a>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal for Ask Advisor -->
    <div id="askAdvisorModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">Minta Bantuan Advisor</div>
                <button class="close" id="closeAskAdvisorModal">&times;</button>
            </div>
            <div class="modal-body">
                <form id="askAdvisorForm">
                    <div class="form-group">
                        <label for="requestQuery">Query/Topik ERD:</label>
                        <input type="text" id="requestQuery" readonly>
                    </div>
                    <div class="form-group">
                        <label for="requestDescription">Deskripsi Detail:</label>
                        <textarea 
                            id="requestDescription" 
                            rows="4" 
                            placeholder="Jelaskan secara detail ERD yang Anda butuhkan, termasuk entitas, atribut, dan relasi yang diinginkan..."
                            required
                        ></textarea>
                    </div>
                    <div class="modal-actions">
                        <button type="button" onclick="closeAskAdvisorModal()" class="btn-secondary">Batal</button>
                        <button type="submit" class="btn-primary">Kirim Request</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

     <!-- SUCCESS POPUP (Hijau) -->
    <div class="popup-overlay hidden" id="successPopup">
        <div class="popup">
            <div class="popup-header success">
                <div class="icon-wrapper">
                    <svg class="popup-icon" viewBox="0 0 24 24">
                        <path d="M20 6L9 17l-5-5"></path>
                    </svg>
                </div>
            </div>
            <div class="popup-body">
                <h2 class="popup-title" id="successPopupTitle">Berhasil!</h2>
                <p class="popup-message" id="successPopupMessage">
                    Operasi berhasil dilakukan.
                </p>
                <div class="popup-buttons single">
                    <button class="popup-btn popup-btn-success" onclick="closeSuccessPopup()">OK</button>
                </div>
            </div>
        </div>
    </div>

    <!-- WARNING POPUP (Orange/Kuning) -->
    <div class="popup-overlay hidden" id="warningPopup">
        <div class="popup">
            <div class="popup-header warning">
                <div class="icon-wrapper">
                    <svg class="popup-icon" viewBox="0 0 24 24">
                        <circle cx="12" cy="12" r="10"></circle>
                        <path d="M12 16v-4M12 8h.01"></path>
                    </svg>
                </div>
            </div>
            <div class="popup-body">
                <h2 class="popup-title" id="warningPopupTitle">Konfirmasi</h2>
                <p class="popup-message" id="warningPopupMessage">
                    Apakah Anda yakin?
                </p>
                <div class="popup-buttons">
                    <button class="popup-btn popup-btn-secondary" onclick="closeWarningPopup(false)">Batal</button>
                    <button class="popup-btn popup-btn-warning" onclick="closeWarningPopup(true)">Ya, Lanjutkan</button>
                </div>
            </div>
        </div>
    </div>

    <!-- ERROR POPUP (Merah) -->
    <div class="popup-overlay hidden" id="errorPopup">
        <div class="popup">
            <div class="popup-header error">
                <div class="icon-wrapper">
                    <svg class="popup-icon" viewBox="0 0 24 24">
                        <circle cx="12" cy="12" r="10"></circle>
                        <line x1="15" y1="9" x2="9" y2="15"></line>
                        <line x1="9" y1="9" x2="15" y2="15"></line>
                    </svg>
                </div>
            </div>
            <div class="popup-body">
                <h2 class="popup-title" id="errorPopupTitle">Gagal!</h2>
                <p class="popup-message" id="errorPopupMessage">
                    Terjadi kesalahan.
                </p>
                <div class="popup-buttons single">
                    <button class="popup-btn popup-btn-error" onclick="closeErrorPopup()">OK</button>
                </div>
            </div>
        </div>
    </div>


    <script src="{{ url_for('static', filename='js/auth.js') }}"></script>
    <script src="{{ url_for('static', filename='js/main.js') }}"></script>
    <script src="{{ url_for('static', filename='js/user_dashboard.js') }}"></script>
    
    <script>
        // Toggle Sidebar Function
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            sidebar.classList.toggle('collapsed');
            
            // Save state to localStorage
            const isCollapsed = sidebar.classList.contains('collapsed');
            localStorage.setItem('sidebarCollapsed', isCollapsed);
        }
        // Initialize user dashboard
        document.addEventListener('DOMContentLoaded', function() {
            if (!requireAuth()) return;
            
            const user = getUser();
            if (!user || user.role !== 'user') {
                window.location.href = '/login';
                return;
            }

            // Restore sidebar state from localStorage
            const sidebarCollapsed = localStorage.getItem('sidebarCollapsed') === 'true';
            if (sidebarCollapsed) {
                document.getElementById('sidebar').classList.add('collapsed');
            }
            
            initUserDashboard();
        });
    </script>
</body>
</html>